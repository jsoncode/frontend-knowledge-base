# 细化章节：HTML 多媒体与图形（Multimedia & Graphics）

---

## 一、多媒体元素：`<audio>` 与 `<video>`

### 1. 基础语法与属性

#### `<audio>` 标签
```html
<audio controls preload="metadata" autoplay loop>
  <source src="music.mp3" type="audio/mpeg">
  <source src="music.ogg" type="audio/ogg">
  您的浏览器不支持 audio 元素。
</audio>
```

#### `<video>` 标签
```html
<video width="640" height="360" controls poster="preview.jpg">
  <source src="movie.mp4" type="video/mp4">
  <source src="movie.webm" type="video/webm">
  <track kind="subtitles" src="subtitles_en.vtt" srclang="en" label="English">
  您的浏览器不支持 video 元素。
</video>
```

### 2. 核心属性说明

| 属性 | 说明 |
|------|------|
| `controls` | 显示播放控件（播放/暂停、音量、进度条） |
| `autoplay` | 自动播放（现代浏览器通常限制有声音的自动播放） |
| `loop` | 循环播放 |
| `muted` | 静音（常与 `autoplay` 配合绕过自动播放限制） |
| `preload` | 预加载策略：<br>`none`（不预加载）<br>`metadata`（仅元数据）<br>`auto`（尽可能加载） |
| `poster` | 视频封面图（仅 `video`） |
| `width` / `height` | 设置显示尺寸（保持宽高比） |

> 💡 **技巧**：
> - 使用多个 `<source>` 提供不同格式，确保浏览器兼容性。
> - 推荐格式：
    >   - 音频：`MP3`（兼容性好）、`OGG`（开源）
>   - 视频：`MP4 (H.264)`（最广泛）、`WebM`（开源，Chrome/Firefox 支持）

---

### 3. `<track>` 字幕与元数据

用于添加字幕、章节、描述等文本轨道。

```html
<track 
  kind="subtitles" 
  src="zh.vtt" 
  srclang="zh" 
  label="中文" 
  default
>
```

| 属性 | 说明 |
|------|------|
| `kind` | 轨道类型：<br>`subtitles`（字幕）<br>`captions`（含音效描述）<br>`descriptions`（音频描述）<br>`chapters`（章节）<br>`metadata`（脚本使用） |
| `src` | WebVTT 文件路径（`.vtt`） |
| `srclang` | 语言代码 |
| `label` | 用户可见标签 |
| `default` | 默认启用该轨道 |

> ✅ **WebVTT 示例（subtitles_en.vtt）**：
> ```
> WEBVTT
>
> 1
> 00:00:01.000 --> 00:00:04.000
> Hello, welcome to the video.
>
> 2
> 00:00:05.000 --> 00:00:08.000
> This is a subtitle example.
> ```

---

### 4. JavaScript 控制多媒体

通过 DOM API 控制播放行为。

```js
const video = document.querySelector('video');

// 常用方法
video.play();           // 播放
video.pause();          // 暂停
video.load();           // 重新加载媒体

// 常用属性
console.log(video.duration);    // 总时长（秒）
console.log(video.currentTime); // 当前播放时间
console.log(video.volume);      // 音量（0-1）
console.log(video.paused);      // 是否暂停

// 事件监听
video.addEventListener('play', () => console.log('开始播放'));
video.addEventListener('pause', () => console.log('暂停'));
video.addEventListener('timeupdate', () => {
  console.log('当前时间:', video.currentTime);
});
video.addEventListener('ended', () => console.log('播放结束'));
video.addEventListener('loadedmetadata', () => {
  console.log('元数据加载完成:', video.duration);
});
```

> ✅ **自动播放策略（现代浏览器）**：
> - 有声音的媒体通常禁止自动播放。
> - 可行方案：
    >   ```js
>   // 方案1：静音自动播放
>   video.muted = true;
>   video.play();
>
>   // 方案2：用户交互后播放
>   document.addEventListener('click', () => video.play(), { once: true });
>   ```

---

## 二、Canvas 图形绘制

### 1. 基本结构

```html
<canvas id="myCanvas" width="400" height="300">
  您的浏览器不支持 Canvas。
</canvas>
```

> ⚠️ 注意：
> - `width` 和 `height` 应通过 HTML 属性设置，而非 CSS，否则会导致拉伸模糊。
> - 默认画布大小为 `300x150px`。

### 2. 获取上下文与绘图基础

```js
const canvas = document.getElementById('myCanvas');
const ctx = canvas.getContext('2d'); // 2D 渲染上下文
```

### 3. 常用绘图 API

#### （1）绘制矩形
```js
ctx.fillStyle = 'red';           // 填充颜色
ctx.fillRect(10, 10, 100, 50);   // (x, y, width, height)

ctx.strokeStyle = 'blue';        // 边框颜色
ctx.strokeRect(130, 10, 100, 50);

ctx.clearRect(50, 20, 20, 20);   // 清除区域
```

#### （2）绘制路径（线条、多边形）
```js
ctx.beginPath();
ctx.moveTo(20, 20);              // 起点
ctx.lineTo(100, 20);             // 画线到
ctx.lineTo(100, 80);
ctx.closePath();                 // 闭合路径（自动连接起点）
ctx.stroke();                    // 描边
ctx.fill();                      // 填充
```

#### （3）绘制圆形/弧
```js
ctx.beginPath();
ctx.arc(200, 100, 50, 0, Math.PI * 2); // (x, y, r, startAngle, endAngle, anticlockwise)
ctx.stroke();
```

#### （4）文本绘制
```js
ctx.font = '20px Arial';
ctx.fillStyle = 'black';
ctx.fillText('Hello Canvas', 10, 30);        // 填充文本
ctx.strokeText('Outline Text', 10, 60);      // 描边文本
```

#### （5）图像绘制
```js
const img = new Image();
img.onload = function () {
  ctx.drawImage(img, 0, 0);                    // (image, x, y)
  ctx.drawImage(img, 0, 0, 200, 150);          // (image, x, y, width, height)
  ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh); // 裁剪并绘制
};
img.src = 'picture.jpg';
```

---

### 4. 状态管理与变换

```js
ctx.save();        // 保存当前状态（样式、变换）
ctx.translate(100, 50);   // 移动画布原点
ctx.rotate(0.5);   // 旋转（弧度）
ctx.scale(2, 2);   // 缩放
ctx.restore();     // 恢复到 save() 时的状态
```

---

### 5. 动画实现（requestAnimationFrame）

```js
let x = 0;

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height); // 清除画布
  ctx.fillRect(x, 100, 50, 50);
  x += 2;
  if (x > canvas.width) x = -50;
  requestAnimationFrame(animate); // 下一帧重绘
}

animate();
```

> ✅ **性能技巧**：
> - 避免频繁创建对象（如颜色、字体）。
> - 使用离屏 Canvas 预渲染复杂图形。
> - 合理控制动画帧率。

---

## 三、SVG（可缩放矢量图形）

### 1. 基本概念

- **SVG** 是基于 XML 的矢量图形格式，无限缩放不失真。
- 可内联在 HTML 中，也可作为 `<img src="*.svg">` 引入。
- 支持 CSS 样式和 JavaScript 操作。

### 2. 常见 SVG 元素

```html
<svg width="200" height="200" viewBox="0 0 200 200">
  <!-- 矩形 -->
  <rect x="10" y="10" width="50" height="30" fill="green" />

  <!-- 圆 -->
  <circle cx="100" cy="60" r="40" fill="red" />

  <!-- 线条 -->
  <line x1="0" y1="0" x2="200" y2="200" stroke="black" stroke-width="2" />

  <!-- 多边形 -->
  <polygon points="100,10 150,190 50,190" fill="blue" />

  <!-- 路径（Path） -->
  <path d="M10 10 H90 V90 H10 Z" fill="yellow" />

  <!-- 文本 -->
  <text x="100" y="180" font-size="20" text-anchor="middle">SVG Text</text>
</svg>
```

### 3. SVG 与 Canvas 对比

| 特性 | SVG | Canvas |
|------|-----|--------|
| 类型 | 矢量图形 | 位图（像素） |
| 缩放 | 无损 | 可能失真 |
| DOM | 有（可绑定事件） | 无（整体为一个元素） |
| 适合场景 | 图标、图表、交互图形 | 游戏、图像处理、复杂动画 |
| 性能 | 对象多时可能变慢 | 大量绘制时更高效 |
| 可访问性 | 支持 ARIA、语义化标签 | 需手动实现 |

---

### 4. SVG 高级特性

#### （1）渐变与图案
```xml
<defs>
  <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
    <stop offset="0%" style="stop-color:red" />
    <stop offset="100%" style="stop-color:yellow" />
  </linearGradient>
</defs>
<rect x="10" y="10" width="100" height="50" fill="url(#grad1)" />
```

#### （2）动画（SMIL）
```xml
<circle cx="50" cy="50" r="20" fill="blue">
  <animate 
    attributeName="cx" 
    from="50" to="150" 
    dur="2s" 
    repeatCount="indefinite" 
  />
</circle>
```

> ⚠️ 注意：SMIL 动画在部分浏览器（如 Chrome）已弃用，推荐使用 CSS 或 JavaScript 控制。

#### （3）滤镜与特效
```xml
<filter id="blur">
  <feGaussianBlur in="SourceGraphic" stdDeviation="5" />
</filter>
<circle cx="100" cy="100" r="50" fill="green" filter="url(#blur)" />
```

---

## 四、`<picture>` 与响应式图片

### 1. 解决多设备图片适配问题

```html
<picture>
  <source media="(max-width: 799px)" srcset="small.jpg">
  <source media="(min-width: 800px)" srcset="large.jpg">
  <img src="fallback.jpg" alt="描述">
</picture>
```

### 2. 支持不同格式（现代格式优先）

```html
<picture>
  <source type="image/webp" srcset="photo.webp">
  <source type="image/jpeg" srcset="photo.jpg">
  <img src="photo.jpg" alt="风景照">
</picture>
```

> ✅ **优势**：
> - 浏览器按顺序匹配，使用第一个符合条件的资源。
> - 可结合 `srcset` + `sizes` 实现分辨率适配。

---

## 五、面试高频问题

1. **`<video>` 自动播放在移动端为什么无效？**
   > 出于用户体验考虑，现代浏览器（尤其是移动端）禁止有声音的视频自动播放。解决方案：添加 `muted` 属性或通过用户交互触发播放。

2. **Canvas 和 SVG 有什么区别？适用场景？**
   > - Canvas 是像素级绘制，适合高频率更新（如游戏）。
   > - SVG 是矢量 DOM，适合交互式图标、图表。
   > - Canvas 性能好但难交互；SVG 易交互但节点过多时性能下降。

3. **如何实现 Canvas 图片压缩？**
   > 使用 `canvas.toDataURL('image/jpeg', quality)`，`quality` 为 0-1 之间。
   > ```js
   > const dataURL = canvas.toDataURL('image/jpeg', 0.7); // 70% 质量
   > ```

4. **WebVTT 文件的作用是什么？**
   > 用于为 `<video>` 提供字幕、章节、描述等文本轨道，提升可访问性和多语言支持。

5. **`<picture>` 和 `srcset` 有什么区别？**
   > - `srcset` 用于同一图片的不同分辨率版本（响应式图像）。
   > - `<picture>` 用于不同条件下加载不同图片（如艺术方向、格式降级）。

6. **如何监听视频播放进度？**
   > 监听 `timeupdate` 事件，结合 `video.currentTime` 和 `video.duration` 计算进度。

---

## 六、实用技巧与最佳实践

| 场景 | 推荐做法 |
|------|--------|
| 音频播放控制 | 使用 `Audio()` 构造函数创建无界面音频对象 |
| 视频预加载 | `preload="metadata"` 平衡体验与流量 |
| 图片懒加载 | `loading="lazy"` 或 Intersection Observer |
| Canvas 动画 | 使用 `requestAnimationFrame` 而非 `setInterval` |
| SVG 图标管理 | 使用雪碧图（Sprite）或 Icon Font / Web Component |
| 多媒体可访问性 | 提供字幕、描述、键盘控制 |
| 性能优化 | 视频压缩、Canvas 分层渲染、避免频繁重绘 |

```js
// 使用 Intersection Observer 实现视频懒播放
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.play();
    } else {
      entry.target.pause();
    }
  });
});
observer.observe(videoElement);
```

---

> **总结**：  
> 多媒体与图形是前端表现力的核心。资深开发者应掌握：
> - 原生 `<audio>`/`<video>` 的完整控制与兼容性处理
> - Canvas 实现动态图形、动画、图像处理
> - SVG 创建高质量、可交互的矢量图形
> - 响应式图片与现代格式（WebP）优化
> - 可访问性与性能的平衡（如懒加载、自动播放策略）
