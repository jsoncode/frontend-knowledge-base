# ç»†åŒ–ç« èŠ‚ï¼šWeb API æ‰©å±•ï¼ˆWeb APIsï¼‰

---

## ä¸€ã€æ¦‚è¿°

ç°ä»£æµè§ˆå™¨æä¾›äº†ä¸°å¯Œçš„ **Web API**ï¼Œä½¿å‰ç«¯èƒ½å¤Ÿå®ç°å¤æ‚åŠŸèƒ½ï¼Œè¶…è¶Šä¼ ç»Ÿçš„ DOM æ“ä½œã€‚è¿™äº› API æ„æˆäº†â€œç°ä»£å‰ç«¯å¼€å‘â€çš„èƒ½åŠ›è¾¹ç•Œï¼Œæ˜¯èµ„æ·±å¼€å‘è€…å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæŠ€èƒ½ã€‚

> âœ… **Web API åˆ†ç±»**ï¼š
> - å­˜å‚¨ç±»ï¼š`localStorage`, `sessionStorage`, `IndexedDB`, `Cache API`
> - å¤šçº¿ç¨‹ç±»ï¼š`Web Workers`, `Service Workers`
> - è®¾å¤‡ç±»ï¼š`Geolocation`, `Device Orientation`, `Battery`, `Vibration`
> - é€šä¿¡ç±»ï¼š`Fetch`, `WebSocket`, `WebRTC`, `BroadcastChannel`, `postMessage`
> - æ–‡ä»¶ä¸æ‹–æ‹½ï¼š`File API`, `Drag & Drop`, `Clipboard API`
> - åª’ä½“ç±»ï¼š`MediaDevices`, `Canvas`, `Web Audio API`
> - æ€§èƒ½ä¸ç›‘æ§ï¼š`Performance API`, `Intersection Observer`, `MutationObserver`
> - å…¶ä»–ï¼š`Fullscreen API`, `Page Visibility API`, `Notification API`

---

## äºŒã€Web Storageï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰

### 1. `localStorage` ä¸ `sessionStorage`

| ç‰¹æ€§ | `localStorage` | `sessionStorage` |
|------|----------------|------------------|
| æŒä¹…æ€§ | æ°¸ä¹…ï¼ˆé™¤éæ‰‹åŠ¨æ¸…é™¤ï¼‰ | ä¼šè¯çº§ï¼ˆå…³é—­æ ‡ç­¾é¡µå³æ¸…é™¤ï¼‰ |
| ä½œç”¨åŸŸ | åŒæºå…±äº« | åŒæº + åŒæ ‡ç­¾é¡µ |
| å®¹é‡ | çº¦ 5-10MB | çº¦ 5-10MB |
| æ•°æ®ç±»å‹ | ä»…å­—ç¬¦ä¸²ï¼ˆéœ€ `JSON.stringify`ï¼‰ | åŒå·¦ |
| äº‹ä»¶ | `storage` äº‹ä»¶è·¨æ ‡ç­¾é¡µé€šä¿¡ | ä¸è§¦å‘ `storage` |

### 2. å¸¸ç”¨æ“ä½œ

```js
// å­˜å‚¨
localStorage.setItem('theme', 'dark');
sessionStorage.setItem('token', 'abc123');

// è¯»å–
const theme = localStorage.getItem('theme');

// åˆ é™¤
localStorage.removeItem('theme');
localStorage.clear(); // æ¸…ç©ºæ‰€æœ‰

// ç›‘å¬å˜åŒ–ï¼ˆä»… localStorageï¼‰
window.addEventListener('storage', (e) => {
  console.log(`Key: ${e.key}, Old: ${e.oldValue}, New: ${e.newValue}`);
});
```

### 3. ä½¿ç”¨åœºæ™¯ä¸é™åˆ¶

- âœ… **é€‚ç”¨åœºæ™¯**ï¼š
    - ç”¨æˆ·åå¥½ï¼ˆä¸»é¢˜ã€è¯­è¨€ï¼‰
    - ç¼“å­˜éæ•æ„Ÿæ•°æ®
    - å•é¡µåº”ç”¨çŠ¶æ€æŒä¹…åŒ–
    - è·¨æ ‡ç­¾é¡µé€šä¿¡ï¼ˆ`localStorage` + `storage` äº‹ä»¶ï¼‰

- âŒ **é™åˆ¶**ï¼š
    - åŒæ­¥é˜»å¡ï¼ˆå¤§é‡è¯»å†™å½±å“æ€§èƒ½ï¼‰
    - ä»…å­—ç¬¦ä¸²å­˜å‚¨
    - ä¸»çº¿ç¨‹æ“ä½œï¼Œå¯èƒ½é˜»å¡æ¸²æŸ“
    - å®¹é‡æœ‰é™ï¼Œä¸é€‚åˆå¤§æ–‡ä»¶

> ğŸ’¡ **æŠ€å·§**ï¼šå°è£…å·¥å…·å‡½æ•°å¤„ç† JSON åºåˆ—åŒ–ï¼š
> ```js
> const Storage = {
>   set(key, value) {
>     localStorage.setItem(key, JSON.stringify(value));
>   },
>   get(key) {
>     const val = localStorage.getItem(key);
>     return val ? JSON.parse(val) : null;
>   }
> };
> ```

---

## ä¸‰ã€Web Workersï¼ˆå¤šçº¿ç¨‹ï¼‰

### 1. æ ¸å¿ƒæ¦‚å¿µ

- å…è®¸åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œ JavaScriptï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼ˆUI çº¿ç¨‹ï¼‰ã€‚
- ä¸èƒ½è®¿é—® DOMã€`window`ã€`document` ç­‰ä¸»çº¿ç¨‹å¯¹è±¡ã€‚
- é€šè¿‡ `postMessage` ä¸ä¸»çº¿ç¨‹é€šä¿¡ã€‚

### 2. åŸºæœ¬ä½¿ç”¨

#### ä¸»çº¿ç¨‹ï¼ˆmain.jsï¼‰
```js
const worker = new Worker('worker.js');

worker.postMessage({ data: [1, 2, 3, 4, 5] });

worker.onmessage = function (e) {
  console.log('æ¥æ”¶åˆ°ç»“æœ:', e.data);
};

worker.onerror = function (e) {
  console.error('Worker é”™è¯¯:', e.message);
};
```

#### Worker çº¿ç¨‹ï¼ˆworker.jsï¼‰
```js
self.onmessage = function (e) {
  const data = e.data.data;
  // æ‰§è¡Œå¤æ‚è®¡ç®—
  const result = data.map(x => x * x);
  self.postMessage(result);
};
```

### 3. ä½¿ç”¨åœºæ™¯

- å¤§æ•°æ®å¤„ç†ï¼ˆæ’åºã€è¿‡æ»¤ã€è§£æï¼‰
- å›¾åƒ/éŸ³è§†é¢‘ç¼–ç è§£ç 
- åŠ å¯†è§£å¯†è¿ç®—
- é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼ˆé¿å…é¡µé¢å¡é¡¿ï¼‰

### 4. æ³¨æ„äº‹é¡¹

- Worker æ–‡ä»¶å¿…é¡»é€šè¿‡ HTTP(S) åŠ è½½ï¼ˆä¸èƒ½ `file://`ï¼‰
- å¯ä»¥ `importScripts()` å¼•å…¥å…¶ä»–è„šæœ¬
- å¯ä»¥é€’å½’åˆ›å»ºå­ Workerï¼ˆ`Nested Workers`ï¼‰
- å†…å­˜ç‹¬ç«‹ï¼Œæ•°æ®é€šè¿‡ç»“æ„åŒ–å…‹éš†ï¼ˆStructured Cloneï¼‰ä¼ é€’

> âš ï¸ **ä¸èƒ½ä¼ é€’**ï¼šå‡½æ•°ã€Errorã€DOM èŠ‚ç‚¹ã€ä¸å¯å…‹éš†å¯¹è±¡

---

## å››ã€Service Workersï¼ˆæœåŠ¡å·¥ä½œè€…ï¼‰

### 1. æ ¸å¿ƒåŠŸèƒ½

- ä¸€ç§ç‰¹æ®Šçš„ Web Workerï¼Œä½œä¸º**ç½‘ç»œä»£ç†**ï¼Œæ‹¦æˆªå’Œæ§åˆ¶é¡µé¢çš„ç½‘ç»œè¯·æ±‚ã€‚
- æ”¯æŒç¦»çº¿è®¿é—®ã€èµ„æºç¼“å­˜ã€æ¶ˆæ¯æ¨é€ã€åå°åŒæ­¥ã€‚
- æ˜¯ PWAï¼ˆProgressive Web Appï¼‰çš„æ ¸å¿ƒæŠ€æœ¯ã€‚

### 2. ç”Ÿå‘½å‘¨æœŸ

1. **æ³¨å†Œ**ï¼š`navigator.serviceWorker.register('sw.js')`
2. **å®‰è£…ï¼ˆinstallï¼‰**ï¼šç¼“å­˜é™æ€èµ„æº
3. **æ¿€æ´»ï¼ˆactivateï¼‰**ï¼šæ¸…é™¤æ—§ç¼“å­˜ï¼Œæ¥ç®¡é¡µé¢
4. **è¿è¡Œ**ï¼šç›‘å¬ `fetch`ã€`push`ã€`sync` ç­‰äº‹ä»¶

### 3. åŸºç¡€ç¤ºä¾‹ï¼ˆç¦»çº¿ç¼“å­˜ï¼‰

#### æ³¨å†Œ SW
```js
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(reg => console.log('SW registered'))
    .catch(err => console.log('SW registration failed', err));
}
```

#### `sw.js`
```js
const CACHE_NAME = 'v1';
const urlsToCache = [
  '/',
  '/index.html',
  '/styles.css',
  '/app.js'
];

// å®‰è£…æ—¶ç¼“å­˜èµ„æº
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(urlsToCache))
  );
});

// æ‹¦æˆªè¯·æ±‚ï¼Œä¼˜å…ˆè¿”å›ç¼“å­˜
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        return response || fetch(event.request);
      })
  );
});

// æ¿€æ´»æ—¶æ¸…ç†æ—§ç¼“å­˜
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(name => {
          if (name !== CACHE_NAME) {
            return caches.delete(name);
          }
        })
      );
    })
  );
});
```

### 4. é«˜çº§åŠŸèƒ½

- **Push Notifications**ï¼šé€šè¿‡ `push` äº‹ä»¶æ¥æ”¶æœåŠ¡å™¨æ¨é€
- **Background Sync**ï¼šç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥æ•°æ®
- **Cache API**ï¼šç²¾ç»†åŒ–æ§åˆ¶ç¼“å­˜ç­–ç•¥ï¼ˆCache First, Network First, Stale While Revalidateï¼‰

---

## äº”ã€Geolocation APIï¼ˆåœ°ç†ä½ç½®ï¼‰

### 1. è·å–ç”¨æˆ·ä½ç½®

```js
if ('geolocation' in navigator) {
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const { latitude, longitude } = position.coords;
      console.log(`ä½ç½®: ${latitude}, ${longitude}`);
    },
    (error) => {
      console.error('è·å–ä½ç½®å¤±è´¥:', error.message);
    },
    {
      enableHighAccuracy: true,  // é«˜ç²¾åº¦ï¼ˆå¯èƒ½å¯ç”¨ GPSï¼‰
      timeout: 10000,            // è¶…æ—¶æ—¶é—´
      maximumAge: 60000          // ç¼“å­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    }
  );
} else {
  console.log('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®');
}
```

### 2. æŒç»­ç›‘å¬ä½ç½®å˜åŒ–

```js
const watchId = navigator.geolocation.watchPosition(
  (position) => {
    console.log('ä½ç½®æ›´æ–°:', position.coords);
  },
  (error) => { /* é”™è¯¯å¤„ç† */ }
);

// åœæ­¢ç›‘å¬
// navigator.geolocation.clearWatch(watchId);
```

### 3. å®‰å…¨ä¸éšç§

- å¿…é¡»ç”¨æˆ·æˆæƒï¼ˆHTTPS ç¯å¢ƒä¸‹æ‰å¯è¯·æ±‚ï¼‰
- ä½ç½®ç²¾åº¦å—è®¾å¤‡å’Œç¯å¢ƒå½±å“
- ä¸å¯ç”¨äºç²¾ç¡®å¯¼èˆªï¼ˆå¦‚ GPS çº§åˆ«ï¼‰

---

## å…­ã€Drag & Drop API

### 1. åŸºæœ¬æµç¨‹

- æ‹–æ‹½æºï¼šè®¾ç½® `draggable="true"`
- ç›‘å¬äº‹ä»¶ï¼š`dragstart`, `drag`, `dragend`
- ç›®æ ‡åŒºåŸŸï¼šç›‘å¬ `dragenter`, `dragover`, `drop`

### 2. ç¤ºä¾‹ä»£ç 

```html
<div id="draggable" draggable="true">æ‹–æˆ‘</div>
<div id="dropzone">æ”¾è¿™é‡Œ</div>
```

```js
const draggable = document.getElementById('draggable');
const dropzone = document.getElementById('dropzone');

draggable.addEventListener('dragstart', (e) => {
  e.dataTransfer.setData('text/plain', 'Hello from drag');
  e.dataTransfer.effectAllowed = 'copy';
});

dropzone.addEventListener('dragover', (e) => {
  e.preventDefault(); // å…è®¸æ”¾ç½®
  e.dataTransfer.dropEffect = 'copy';
});

dropzone.addEventListener('drop', (e) => {
  e.preventDefault();
  const data = e.dataTransfer.getData('text/plain');
  dropzone.textContent = data;
});
```

### 3. æŠ€å·§

- `e.preventDefault()` åœ¨ `dragover` ä¸­å¿…é¡»è°ƒç”¨ï¼Œå¦åˆ™æ— æ³•è§¦å‘ `drop`
- `dataTransfer` å¯å­˜å‚¨å¤šç§æ ¼å¼æ•°æ®
- å¯æ‹–æ‹½æ–‡ä»¶ï¼ˆè§ File APIï¼‰

---

## ä¸ƒã€Clipboard APIï¼ˆå‰ªè´´æ¿ï¼‰

### 1. è¯»å†™å‰ªè´´æ¿ï¼ˆéœ€ç”¨æˆ·æ‰‹åŠ¿ï¼‰

```js
// å†™å…¥æ–‡æœ¬
async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    console.log('å¤åˆ¶æˆåŠŸ');
  } catch (err) {
    console.error('å¤åˆ¶å¤±è´¥:', err);
  }
}

// è¯»å–æ–‡æœ¬
async function pasteText() {
  try {
    const text = await navigator.clipboard.readText();
    console.log('ç²˜è´´å†…å®¹:', text);
  } catch (err) {
    console.error('è¯»å–å¤±è´¥:', err);
  }
}
```

### 2. å®‰å…¨è¦æ±‚

- å¿…é¡»åœ¨ç”¨æˆ·æ‰‹åŠ¿ï¼ˆclickã€keypressï¼‰ä¸­è°ƒç”¨
- éœ€è¦ `https` æˆ– `localhost`
- ç”¨æˆ·å¯èƒ½æ‹’ç»æƒé™

> ğŸ’¡ **å…¼å®¹æ€§é™çº§**ï¼š
> ä½¿ç”¨ `document.execCommand('copy')`ï¼ˆå·²åºŸå¼ƒï¼Œä»…ä½œå…œåº•ï¼‰

---

## å…«ã€å…¶ä»–é‡è¦ Web API

### 1. **Fullscreen API**
```js
element.requestFullscreen();     // è¿›å…¥å…¨å±
document.exitFullscreen();       // é€€å‡ºå…¨å±
document.fullscreenElement;      // å½“å‰å…¨å±å…ƒç´ 
```

### 2. **Page Visibility API**
```js
document.hidden        // é¡µé¢æ˜¯å¦éšè—
document.visibilityState  // 'visible', 'hidden', 'prerender'
document.addEventListener('visibilitychange', handler);
```

### 3. **Intersection Observer**
```js
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      // å…ƒç´ è¿›å…¥è§†å£ï¼ˆå¯ç”¨äºæ‡’åŠ è½½ï¼‰
    }
  });
});
observer.observe(targetElement);
```

### 4. **MutationObserver**
```js
const observer = new MutationObserver((mutations) => {
  mutations.forEach(mutation => {
    console.log('DOM å˜åŒ–:', mutation);
  });
});
observer.observe(targetNode, { childList: true, subtree: true });
```

### 5. **Notification API**
```js
if (Notification.permission === 'granted') {
  new Notification('æ ‡é¢˜', { body: 'å†…å®¹' });
} else if (Notification.permission !== 'denied') {
  Notification.requestPermission().then(perm => {
    if (perm === 'granted') new Notification('Hello');
  });
}
```

---

## ä¹ã€é¢è¯•é«˜é¢‘é—®é¢˜

1. **`localStorage` å’Œ `Cookie` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
   > - `localStorage` å®¹é‡å¤§ï¼ˆ5-10MBï¼‰ï¼Œä¸éšè¯·æ±‚å‘é€ï¼Œä»…å­—ç¬¦ä¸²ã€‚
   > - `Cookie` å®¹é‡å°ï¼ˆ4KBï¼‰ï¼Œéšæ¯æ¬¡è¯·æ±‚å‘é€ï¼Œæ”¯æŒè¿‡æœŸã€è·¯å¾„ã€åŸŸã€å®‰å…¨å±æ€§ã€‚

2. **Web Worker èƒ½è®¿é—® DOM å—ï¼Ÿå¦‚ä½•é€šä¿¡ï¼Ÿ**
   > ä¸èƒ½ã€‚é€šè¿‡ `postMessage` å‘é€æ¶ˆæ¯ï¼Œç›‘å¬ `onmessage` æ¥æ”¶ã€‚

3. **Service Worker çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•å®ç°ç¦»çº¿è®¿é—®ï¼Ÿ**
   > ä½œä¸ºç½‘ç»œä»£ç†ï¼Œæ‹¦æˆªè¯·æ±‚å¹¶è¿”å›ç¼“å­˜èµ„æºã€‚é€šè¿‡ `Cache API` ç¼“å­˜å…³é”®èµ„æºï¼Œåœ¨ `fetch` äº‹ä»¶ä¸­ä¼˜å…ˆè¿”å›ç¼“å­˜ã€‚

4. **å¦‚ä½•å®ç°å›¾ç‰‡æ‡’åŠ è½½ï¼Ÿ**
   > ä½¿ç”¨ `Intersection Observer` ç›‘å¬å›¾ç‰‡æ˜¯å¦è¿›å…¥è§†å£ï¼Œè¿›å…¥åå†åŠ è½½ `src`ã€‚

5. **`navigator.clipboard` ä¸ºä»€ä¹ˆæœ‰æ—¶æ— æ³•ä½¿ç”¨ï¼Ÿ**
   > éœ€ç”¨æˆ·æ‰‹åŠ¿è§¦å‘ã€HTTPS ç¯å¢ƒã€ç”¨æˆ·æˆæƒã€‚å¯é™çº§ä½¿ç”¨ `execCommand`ã€‚

6. **Geolocation è·å–çš„ä½ç½®ç²¾ç¡®å—ï¼Ÿ**
   > å–å†³äºè®¾å¤‡ï¼ˆGPSã€Wi-Fiã€IPï¼‰ï¼Œç²¾åº¦ä»å‡ ç±³åˆ°å‡ å…¬é‡Œä¸ç­‰ï¼Œä¸èƒ½ç”¨äºé«˜ç²¾åº¦å¯¼èˆªã€‚

---

## åã€æœ€ä½³å®è·µä¸æŠ€å·§

| åœºæ™¯ | æ¨èåšæ³• |
|------|--------|
| å¤§æ•°æ®è®¡ç®— | ä½¿ç”¨ Web Worker é¿å…é˜»å¡ UI |
| ç¦»çº¿åº”ç”¨ | Service Worker + Cache API |
| ç”¨æˆ·ä½ç½®æœåŠ¡ | Geolocation + é”™è¯¯å¤„ç† + éšç§æç¤º |
| å‰ªè´´æ¿æ“ä½œ | `navigator.clipboard` + æƒé™æ£€æŸ¥ + é™çº§æ–¹æ¡ˆ |
| æ‡’åŠ è½½ | `Intersection Observer` æ›¿ä»£æ»šåŠ¨äº‹ä»¶ |
| DOM å˜åŒ–ç›‘å¬ | `MutationObserver` æ›¿ä»£è½®è¯¢ |
| è·¨æ ‡ç­¾é¡µé€šä¿¡ | `BroadcastChannel` æˆ– `localStorage` + `storage` äº‹ä»¶ |
| æ€§èƒ½ç›‘æ§ | `Performance API` + `Navigation Timing` |

```js
// ä½¿ç”¨ BroadcastChannel å®ç°æ ‡ç­¾é¡µé€šä¿¡
const channel = new BroadcastChannel('chat');
channel.postMessage({ user: 'Alice', msg: 'Hi' });
channel.addEventListener('message', e => console.log(e.data));
```

---

> **æ€»ç»“**ï¼š  
> Web API æ‰©å±•äº†å‰ç«¯çš„èƒ½åŠ›è¾¹ç•Œã€‚èµ„æ·±å¼€å‘è€…åº”ï¼š
> - ç†Ÿç»ƒæŒæ¡å¸¸ç”¨ API çš„ä½¿ç”¨åœºæ™¯ä¸é™åˆ¶
> - ç†è§£å…¶èƒŒåçš„å®‰å…¨æ¨¡å‹ï¼ˆå¦‚æƒé™ã€åŒæºï¼‰
> - èƒ½ç»“åˆå¤šä¸ª API å®ç°å¤æ‚åŠŸèƒ½ï¼ˆå¦‚ PWAï¼‰
> - å…·å¤‡é™çº§ä¸å…¼å®¹æ€§å¤„ç†èƒ½åŠ›
> - å…³æ³¨æ€§èƒ½ä¸ç”¨æˆ·ä½“éªŒå¹³è¡¡
